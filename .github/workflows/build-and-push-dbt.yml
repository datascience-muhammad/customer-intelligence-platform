name: Build and Push dbt image

on:
  push:
    branches: [ 'main' ]
    tags: [ 'v*', 'release-*' ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push dbt image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/Dockerfile.dbt
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/shopflow-dbt:latest
            ghcr.io/${{ github.repository_owner }}/shopflow-dbt:${{ github.sha }}

      - name: Run dbt deps, test and docs (optional)
        env:
          RDS_HOST: ${{ secrets.RDS_HOST }}
          RDS_USER: ${{ secrets.RDS_USER }}
          RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
          RDS_DB: ${{ secrets.RDS_DB }}
          RDS_PORT: ${{ secrets.RDS_PORT }}
        run: |
          # Only run dbt tests/docs if DB credentials are provided via repository secrets
          if [ -z "$RDS_HOST" ] || [ -z "$RDS_USER" ] || [ -z "$RDS_PASSWORD" ] || [ -z "$RDS_DB" ]; then
            echo "DB credentials not found in secrets; skipping dbt tests and docs generation."
            exit 0
          fi

          IMAGE=ghcr.io/${{ github.repository_owner }}/shopflow-dbt:${{ github.sha }}
          echo "Pulling image $IMAGE"
          docker pull $IMAGE

          echo "Running dbt deps, seed (optional), test, and docs generate inside $IMAGE"
          docker run --rm \
            -e RDS_HOST="$RDS_HOST" \
            -e RDS_USER="$RDS_USER" \
            -e RDS_PASSWORD="$RDS_PASSWORD" \
            -e RDS_DB="$RDS_DB" \
            -e RDS_PORT="$RDS_PORT" \
            $IMAGE bash -lc "cd /usr/app/dbt_shopflow && dbt --version && dbt deps && dbt seed --profiles-dir . || true && dbt test --profiles-dir . && dbt docs generate --profiles-dir ."

# Notes:
# - This workflow pushes to GHCR (ghcr.io). It uses the built-in GITHUB_TOKEN for authentication.
# - If you prefer Docker Hub or another registry, replace the login step with appropriate
#   credentials (store them in repository secrets like REGISTRY_USERNAME and REGISTRY_PASSWORD)
#   and update the `tags` to point to your registry (e.g., myregistry.io/myorg/shopflow-dbt:latest).